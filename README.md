# Отправка уведомлений из zabbix в telegram через webhook с поддержкой эмодзи

Контакты: grayhoax[at]grayhoax.ru

Телеграм: [@grayhoax](https://t.me/grayhoax)



Для работы требуется доступ с сервера Zabbix до адреса:

`ping api.telegram.org`

`telnet api.telegram.org 443`

## Установка

1. Прописать Параметр - `BOT_TOKEN`. Его можно получить у бота [@botfather](https://t.me/botfather) (писать через телеграм). Команда для создания - `/newbot`. Далее - заполнить всё, что он просит. Из завершающего сообщения использовать код вида `267788435192:ABEQ4qgWc15OXyTnDmаE29NdW8IFpGC_xqM` *(этот работать не будет)*. [Ссылка на официальный док](https://core.telegram.org/bots#6-botfather)

2. В настройках пользователей нужно добавить способ оповещения. В поле "Отправлять на" требуется вставить идентификатор пользователя. Этот идентификатор можно получить у бота в телеграм [@getidsbot](https://t.me/getidsbot) написав ему любое сообщение. Идентификатор будет написан в строке `id:`.

3. **Каждый** пользователь должен написать созданному боту *(в пункте 1)* любое сообщение или нажать кнопку `Старт` в диалоге с ним. **Иначе сообщения доходить не будут**.

4. Создать действие *(или отредактировать имеющееся)*. В разделе `Операции` в тексте **МОЖНО** использовать Эмодзи символы. Поскольку Zabbix sender не поддерживает кодировку utf8mb4 - решением проблемы стало вписывание кода символа *(вида \U+1A2B3)* и его преобразование в коде web хука. Таблицу кодом можно посмотреть [по ссылке](https://apps.timwhitlock.info/emoji/tables/unicode). Код символа брать из столбца `Unicode`. **Обязательно нужно добавить обратный слеш в начало кода** — **\\**_U+1A2B3_

## Проверка
Для проверки работы следует использовать ссылку `Тест` напротив созданного способа оповещений. В открывшемся окне заменить значение параметра `chat_id` на свой идентификатор телеграм _(как узнать описано в пункте 2 раздела "установка")_.

Если всё указано правильно - в телеграм поступит сообщение `{ALERT.MESSAGE}` или то, которое Вы вписали.

## Ошибки
В лог zabbix отправляется ошибка, возникшая при выполнении запроса.


401 — ошибочный ключ, нужно проверить корректность параметра `BOT_TOKEN`

403 — возможно пользователь не написал первое сообщение боту

**--- TBD---**
